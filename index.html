<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Gestão da Igreja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para abas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button.active {
            border-bottom-color: #4f46e5;
            /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }

        /* Estilo para o modal */
        .modal {
            display: none;
            /* Oculto por padrão */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            /* Fundo escuro semi-transparente */
            justify-content: center;
            align-items: center;
        }

        .modal.flex {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Estilo para a mensagem de carregamento/erro de autenticação */
        #auth-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.25rem;
            color: #4b5563;
        }

        /* Esconde o conteúdo principal até que a autenticação esteja pronta */
        #main-app {
            display: none;
        }
    </style>
</head>

<body class="h-full">

    <!-- Tela de Autenticação (Login/Cadastro) -->
    <div id="auth-container" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
            <div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Aceder à sua conta
                </h2>
            </div>
            <form id="auth-form" class="mt-8 space-y-6" action="#" method="POST">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                            placeholder="Endereço de email">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Senha</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                            placeholder="Senha (mín. 6 caracteres)">
                    </div>
                </div>

                <p id="auth-error" class="text-center text-sm text-red-600"></p>

                <div>
                    <button id="auth-submit-button" type="submit"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
            </form>
            <div class="text-center">
                <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Não tem uma conta? Crie o seu primeiro acesso.
                </a>
            </div>
        </div>
    </div>

    <!-- Mensagem de Carregamento/Verificação -->
    <div id="auth-loading" class="text-lg text-gray-700">
        A verificar autenticação...
    </div>

    <!-- Aplicação Principal (Oculta até o login) -->
    <div id="main-app" class="min-h-full">
        <div class="bg-gray-800 pb-32">
            <nav class="bg-gray-800">
                <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                    <div class="border-b border-gray-700">
                        <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-8 w-8 text-indigo-400" data-lucide="church" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2" viewBox="0 0 24 24">
                                        <path d="m18 7 4 2v11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9l4-2" />
                                        <path d="M14 22v-4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v4" />
                                        <path d="M18 22V5l-6-3-6 3v17" />
                                        <path d="M12 7v5" />
                                        <path d="M10 9h4" />
                                    </svg>
                                </div>
                                <div class="hidden md:block">
                                    <div class="ml-10 flex items-baseline space-x-4">
                                        <!-- Abas de Navegação -->
                                        <button class="tab-button active" data-tab="tab-dashboard">Dashboard</button>
                                        <button class="tab-button" data-tab="tab-cadastrar-membro">Cadastrar
                                            Membro</button>
                                        <button class="tab-button" data-tab="tab-visualizar-membros">Visualizar
                                            Membros</button>
                                        <button class="tab-button" data-tab="tab-dizimos-reg">Dízimos</button>
                                        <button class="tab-button" data-tab="tab-ofertas-reg">Ofertas e Outras</button>
                                        <button class="tab-button" data-tab="tab-financeiro">Financeiro (Caixa)</button>
                                    </div>
                                </div>
                            </div>
                            <div class="hidden md:block">
                                <div class="ml-4 flex items-center md:ml-6">
                                    <span id="user-email-display" class="text-gray-300 text-sm mr-3"></span>
                                    <button id="logout-button"
                                        class="bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-red-700">
                                        Sair
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Menu Mobile -->
                <div class="border-b border-gray-700 md:hidden" id="mobile-menu">
                    <div class="px-2 py-3 space-y-1 sm:px-3">
                        <button class="tab-button active" data-tab="tab-dashboard">Dashboard</button>
                        <button class="tab-button" data-tab="tab-cadastrar-membro">Cadastrar Membro</button>
                        <button class="tab-button" data-tab="tab-visualizar-membros">Visualizar Membros</button>
                        <button class="tab-button" data-tab="tab-dizimos-reg">Dízimos</button>
                        <button class="tab-button" data-tab="tab-ofertas-reg">Ofertas e Outras</button>
                        <button class="tab-button" data-tab="tab-financeiro">Financeiro (Caixa)</button>
                    </div>
                    <div class="pt-4 pb-3 border-t border-gray-700">
                        <div class="flex items-center px-5">
                            <div class="text-base font-medium text-white" id="user-email-display-mobile"></div>
                        </div>
                        <div class="mt-3 px-2 space-y-1">
                            <button id="logout-button-mobile"
                                class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700">
                                Sair
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <header class="py-10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 id="header-title" class="text-3xl font-bold text-white">Dashboard</h1>
                </div>
            </header>
        </div>

        <main class="-mt-32">
            <div class="max-w-7xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
                <!-- Conteúdo das Abas -->
                <div class="bg-white rounded-lg shadow px-5 py-6 sm:px-6">

                    <!-- Aba Dashboard -->
                    <div id="tab-dashboard" class="tab-content active">
                        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                            <!-- Card Saldo Atual -->
                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <svg class="h-6 w-6 text-gray-400" data-lucide="scale" fill="none"
                                                stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                                stroke-width="2" viewBox="0 0 24 24">
                                                <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
                                                <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
                                                <path d="M7 21h10" />
                                                <path d="M12 3v18" />
                                                <path d="M3 7h2c2 0 5-1 7-1s5 1 7 1h2" />
                                            </svg>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">Saldo Atual
                                                </dt>
                                                <dd>
                                                    <div id="dashboard-saldo"
                                                        class="text-lg font-medium text-gray-900">R$ 0,00</div>
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Card Total de Membros -->
                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <svg class="h-6 w-6 text-gray-400" data-lucide="users" fill="none"
                                                stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                                stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                                <circle cx="9" cy="7" r="4" />
                                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                            </svg>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">Total de Membros
                                                </dt>
                                                <dd>
                                                    <div id="dashboard-membros"
                                                        class="text-lg font-medium text-gray-900">0</div>
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Card Dízimos/Ofertas (Mês) -->
                            <div class="bg-white overflow-hidden shadow rounded-lg">
                                <div class="p-5">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <svg class="h-6 w-6 text-gray-400" data-lucide="piggy-bank" fill="none"
                                                stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                                stroke-width="2" viewBox="0 0 24 24">
                                                <path
                                                    d="M15 10v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1Z" />
                                                <path d="M2 14v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2" />
                                                <path
                                                    d="M18 10V8a2 2 0 0 0-2-2h-1a2 2 0 0 0-2 2v2" />
                                                <path d="M22 10v4" />
                                                <path d"M10 10V5" />
                                                <path d"M10 5a2 2 0 0 1 4 0v5" />
                                            </svg>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="text-sm font-medium text-gray-500 truncate">Entradas (Mês
                                                    Atual)</dt>
                                                <dd>
                                                    <div id="dashboard-entradas-mes"
                                                        class="text-lg font-medium text-gray-900">R$ 0,00</div>
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Cadastrar Membro -->
                    <div id="tab-cadastrar-membro" class="tab-content">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Formulário de Cadastro de Membros</h2>
                        <form id="membro-form" class="space-y-4">
                            <div>
                                <label for="membro-nome"
                                    class="block text-sm font-medium text-gray-700">Nome:</label>
                                <input type="text" id="membro-nome" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-telefone"
                                    class="block text-sm font-medium text-gray-700">Telefone:</label>
                                <input type="tel" id="membro-telefone"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-email"
                                    class="block text-sm font-medium text-gray-700">Email:</label>
                                <input type="email" id="membro-email"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-data-nascimento"
                                    class="block text-sm font-medium text-gray-700">Data de Nascimento:</label>
                                <input type="date" id="membro-data-nascimento"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-data-batismo"
                                    class="block text-sm font-medium text-gray-700">Data de Batismo:</label>
                                <input type="date" id="membro-data-batismo"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-funcao" class="block text-sm font-medium text-gray-700">Função /
                                    Ministério:</label>
                                <input type="text" id="membro-funcao"
                                    placeholder="Ex: Pastor, Diácono, Líder Louvor, Membro"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="membro-endereco"
                                    class="block text-sm font-medium text-gray-700">Endereço:</label>
                                <textarea id="membro-endereco" rows="3"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                            <button type="submit"
                                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Salvar Membro
                            </button>
                            <p id="membro-form-mensagem" class="text-sm text-green-600"></p>
                        </form>
                    </div>

                    <!-- Aba Visualizar Membros -->
                    <div id="tab-visualizar-membros" class="tab-content">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Membros Cadastrados</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Nome</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Telefone</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Função</th>
                                        <th scope="col" class="relative px-6 py-3">
                                            <span class="sr-only">Ações</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="membros-tabela" class="bg-white divide-y divide-gray-200">
                                    <!-- Linhas inseridas via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Aba Dízimos e Ofertas -->
                    <div id="tab-dizimos" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Coluna do Formulário -->
                            <div class="md:col-span-1">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Registro de Entradas</h2>
                                <form id="dizimo-form" class="space-y-4">
                                    <div>
                                        <label for="dizimo-data"
                                            class="block text-sm font-medium text-gray-700">Data:</label>
                                        <input type="date" id="dizimo-data" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="dizimo-membro"
                                            class="block text-sm font-medium text-gray-700">Membro (Opcional):</label>
                                        <select id="dizimo-membro"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="">Anônimo / Não se aplica</option>
                                            <!-- Opções carregadas via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dizimo-valor"
                                            class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                                        <input type="number" step="0.01" id="dizimo-valor" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="100.00">
                                    </div>
                                    <div>
                                        <label for="dizimo-tipo"
                                            class="block text-sm font-medium text-gray-700">Tipo:</label>
                                        <select id="dizimo-tipo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="Dízimo">Dízimo</option>
                                            <option value="Oferta">Oferta</option>
                                            <option value="Venda Evento">Venda Evento</option>
                                            <option value="Outra Entrada">Outra Entrada</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dizimo-descricao"
                                            class="block text-sm font-medium text-gray-700">Descrição
                                            (Opcional):</label>
                                        <input type="text" id="dizimo-descricao"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="Ex: Oferta especial, Cantina">
                                    </div>
                                    <button type="submit"
                                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Registrar Entrada
                                    </button>
                                    <p id="dizimo-form-mensagem" class="text-sm text-green-600"></p>
                                </form>
                            </div>

                            <!-- Coluna dos Relatórios -->
                            <div class="md:col-span-2">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Relatório Mensal de Entradas</h2>
                                <!-- Seletores de Mês/Ano -->
                                <div class="flex space-x-4 mb-4">
                                    <div>
                                        <label for="relatorio-mes"
                                            class="block text-sm font-medium text-gray-700">Mês:</label>
                                        <select id="relatorio-mes"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <!-- Meses carregados via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="relatorio-ano"
                                            class="block text-sm font-medium text-gray-700">Ano:</label>
                                        <input type="number" id="relatorio-ano"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="AAAA">
                                    </div>
                                </div>

                                <!-- Tabela de Dizimistas -->
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Dizimistas do Mês</h3>
                                <div class="overflow-x-auto mb-6">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Data</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Membro</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Valor (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dizimos-tabela" class="bg-white divide-y divide-gray-200">
                                            <!-- Linhas inseridas via JS -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Tabela de Outras Entradas -->
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Outras Entradas (Ofertas, etc.) do
                                    Mês</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Data</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Tipo</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Descrição</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Valor (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ofertas-tabela" class="bg-white divide-y divide-gray-200">
                                            <!-- Linhas inseridas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Dízimos -->
                    <div id="tab-dizimos-reg" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Coluna do Formulário de Dízimo -->
                            <div class="md:col-span-1">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Registro de Dízimo</h2>
                                <form id="form-dizimo-novo" class="space-y-4">
                                    <div>
                                        <label for="dizimo-data-novo"
                                            class="block text-sm font-medium text-gray-700">Data:</label>
                                        <input type="date" id="dizimo-data-novo" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="dizimo-membro-novo"
                                            class="block text-sm font-medium text-gray-700">Membro:</label>
                                        <select id="dizimo-membro-novo" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="">Selecione o Membro</option>
                                            <!-- Opções carregadas via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dizimo-valor-novo"
                                            class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                                        <input type="number" step="0.01" id="dizimo-valor-novo" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="100.00">
                                    </div>
                                    <div>
                                        <label for="dizimo-descricao-novo"
                                            class="block text-sm font-medium text-gray-700">Descrição
                                            (Opcional):</label>
                                        <input type="text" id="dizimo-descricao-novo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="Ex: Referente a Jan/25">
                                    </div>
                                    <button type="submit"
                                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Registrar Dízimo
                                    </button>
                                    <p id="dizimo-novo-mensagem" class="text-sm text-green-600"></p>
                                </form>
                            </div>
                            <!-- Coluna do Relatório de Dízimos -->
                            <div class="md:col-span-2">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Relatório Mensal de Dízimos</h2>
                                <!-- Seletores de Mês/Ano -->
                                <div class="flex space-x-4 mb-4">
                                    <div>
                                        <label for="relatorio-mes-dizimo"
                                            class="block text-sm font-medium text-gray-700">Mês:</label>
                                        <select id="relatorio-mes-dizimo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <!-- Meses carregados via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="relatorio-ano-dizimo"
                                            class="block text-sm font-medium text-gray-700">Ano:</label>
                                        <input type="number" id="relatorio-ano-dizimo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="AAAA">
                                    </div>
                                </div>
                                <!-- Tabela de Dizimistas -->
                                <div class="overflow-x-auto mb-6">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Data</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Membro</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Valor (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dizimos-tabela" class="bg-white divide-y divide-gray-200">
                                            <!-- Linhas inseridas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Ofertas e Outras Entradas -->
                    <div id="tab-ofertas-reg" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Coluna do Formulário de Oferta -->
                            <div class="md:col-span-1">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Registro de Ofertas/Entradas
                                </h2>
                                <form id="form-oferta-nova" class="space-y-4">
                                    <div>
                                        <label for="oferta-data-nova"
                                            class="block text-sm font-medium text-gray-700">Data:</label>
                                        <input type="date" id="oferta-data-nova" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="oferta-membro-novo"
                                            class="block text-sm font-medium text-gray-700">Membro
                                            (Opcional):</label>
                                        <select id="oferta-membro-novo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="">Anônimo / Não se aplica</option>
                                            <!-- Opções carregadas via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="oferta-valor-novo"
                                            class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                                        <input type="number" step="0.01" id="oferta-valor-novo" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="50.00">
                                    </div>
                                    <div>
                                        <label for="oferta-tipo-novo"
                                            class="block text-sm font-medium text-gray-700">Tipo:</label>
                                        <select id="oferta-tipo-novo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="Oferta">Oferta</option>
                                            <option value="Oferta Alçada">Oferta Alçada</option>
                                            <option value="Venda Evento">Venda Evento</option>
                                            <option value="Outra Entrada">Outra Entrada</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="oferta-descricao-nova"
                                            class="block text-sm font-medium text-gray-700">Descrição
                                            (Opcional):</label>
                                        <input type="text" id="oferta-descricao-nova"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="Ex: Oferta especial, Cantina">
                                    </div>
                                    <button type="submit"
                                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Registrar Entrada
                                    </button>
                                    <p id="oferta-novo-mensagem" class="text-sm text-green-600"></p>
                                </form>
                            </div>
                            <!-- Coluna do Relatório de Ofertas -->
                            <div class="md:col-span-2">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Relatório Mensal de
                                    Ofertas/Entradas</h2>
                                <!-- Seletores de Mês/Ano -->
                                <div class="flex space-x-4 mb-4">
                                    <div>
                                        <label for="relatorio-mes-oferta"
                                            class="block text-sm font-medium text-gray-700">Mês:</label>
                                        <select id="relatorio-mes-oferta"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <!-- Meses carregados via JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="relatorio-ano-oferta"
                                            class="block text-sm font-medium text-gray-700">Ano:</label>
                                        <input type="number" id="relatorio-ano-oferta"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="AAAA">
                                    </div>
                                </div>
                                <!-- Tabela de Outras Entradas -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Data</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Tipo</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Descrição</th>
                                                <th
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Valor (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ofertas-tabela" class="bg-white divide-y divide-gray-200">
                                            <!-- Linhas inseridas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Financeiro (Caixa) -->
                    <div id="tab-financeiro" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Coluna do Formulário -->
                            <div class="md:col-span-1">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Lançamento no Caixa</h2>
                                <form id="financeiro-form" class="space-y-4">
                                    <div>
                                        <label for="financeiro-data"
                                            class="block text-sm font-medium text-gray-700">Data:</label>
                                        <input type="date" id="financeiro-data" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="financeiro-descricao"
                                            class="block text-sm font-medium text-gray-700">Descrição:</label>
                                        <input type="text" id="financeiro-descricao" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="Ex: Compra de material limpeza, Conta de luz">
                                    </div>
                                    <div>
                                        <label for="financeiro-valor"
                                            class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                                        <input type="number" step="0.01" id="financeiro-valor" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="100.00">
                                    </div>
                                    <div>
                                        <label for="financeiro-tipo"
                                            class="block text-sm font-medium text-gray-700">Tipo:</label>
                                        <select id="financeiro-tipo"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            <option value="saida">Saída (Despesa)</option>
                                            <option value="entrada">Entrada (Manual)</option>
                                        </select>
                                    </div>
                                    <button type="submit"
                                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Lançar no Caixa
                                    </button>
                                    <p id="financeiro-form-mensagem" class="text-sm text-green-600"></p>
                                </form>
                            </div>
                            <!-- Coluna da Tabela/Extrato -->
                            <div class="md:col-span-2">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Extrato do Caixa</h2>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-lg font-medium text-gray-700">Saldo Atual:</span>
                                    <span id="financeiro-saldo"
                                        class="text-2xl font-bold text-gray-900">R$ 0,00</span>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Data</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Descrição</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Valor (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="financeiro-tabela" class="bg-white divide-y divide-gray-200">
                                            <!-- Linhas inseridas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Detalhes do Membro -->
    <div id="membro-detalhes-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Detalhes do Membro</h2>
                <button id="modal-close-button" class="text-gray-500 hover:text-gray-800">
                    <svg class="h-6 w-6" data-lucide="x" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div id="membro-detalhes-conteudo" class="space-y-3">
                <!-- Conteúdo carregado via JS -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="membro-delete-button"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Excluir Membro
                </button>
                <button id="membro-edit-button"
                    class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Editar
                </button>
            </div>
        </div>
    </div>


    <!-- Scripts Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            addDoc,
            setDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA59Apn8I_8uT7XBrMIS_zD1RdtHgJCzOA",
            authDomain: "gestao-capoeira.firebaseapp.com",
            projectId: "gestao-capoeira",
            storageBucket: "gestao-capoeira.firebasestorage.app",
            messagingSenderId: "907559288919",
            appId: "1:907559288919:web:a4afdb4ed23e9d11196312"
        };

        // Inicializa Firebase
        let app, db, auth;
        let userId = null; // ID do usuário logado
        let unsubMembros = () => { };
        let unsubDizimos = () => { };
        let unsubFinanceiro = () => { };

        // Coleções de dados (listas locais)
        let todosMembros = [];
        let todosDizimos = [];
        let todosFinanceiro = [];

        // Elementos DOM - Autenticação
        const authContainer = document.getElementById('auth-container');
        const authLoading = document.getElementById('auth-loading');
        const mainApp = document.getElementById('main-app');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const emailInput = document.getElementById('email-address');
        const passwordInput = document.getElementById('password');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userEmailDisplayMobile = document.getElementById('user-email-display-mobile');

        // Elementos DOM - Abas e Conteúdo
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const headerTitle = document.getElementById('header-title');

        // Elementos DOM - Formulários
        const membroForm = document.getElementById('membro-form');
        const membroFormMensagem = document.getElementById('membro-form-mensagem');
        const dizimoForm = document.getElementById('dizimo-form');
        const dizimoFormMensagem = document.getElementById('dizimo-form-mensagem');
        const financeiroForm = document.getElementById('financeiro-form');
        const financeiroFormMensagem = document.getElementById('financeiro-form-mensagem');

        // Elementos DOM - Novos Formulários Dízimo/Oferta
        const formDizimoNovo = document.getElementById('form-dizimo-novo');
        const dizimoNovoMensagem = document.getElementById('dizimo-novo-mensagem');
        const dizimoMembroNovoSelect = document.getElementById('dizimo-membro-novo');

        const formOfertaNova = document.getElementById('form-oferta-nova');
        const ofertaNovoMensagem = document.getElementById('oferta-novo-mensagem');
        const ofertaMembroNovoSelect = document.getElementById('oferta-membro-novo');

        // Elementos DOM - Tabelas e Selects
        const membrosTabela = document.getElementById('membros-tabela');
        const dizimoMembroSelect = document.getElementById('dizimo-membro');
        const financeiroTabela = document.getElementById('financeiro-tabela');
        const financeiroSaldo = document.getElementById('financeiro-saldo');
        const dizimosTabela = document.getElementById('dizimos-tabela');
        const ofertasTabela = document.getElementById('ofertas-tabela');
        const relatorioMesSelect = document.getElementById('relatorio-mes');
        const relatorioAnoInput = document.getElementById('relatorio-ano');
        
        const relatorioMesDizimo = document.getElementById('relatorio-mes-dizimo');
        const relatorioAnoDizimo = document.getElementById('relatorio-ano-dizimo');
        const relatorioMesOferta = document.getElementById('relatorio-mes-oferta');
        const relatorioAnoOferta = document.getElementById('relatorio-ano-oferta');

        // Elementos DOM - Dashboard
        const dashboardSaldo = document.getElementById('dashboard-saldo');
        const dashboardMembros = document.getElementById('dashboard-membros');
        const dashboardEntradasMes = document.getElementById('dashboard-entradas-mes');

        // Elementos DOM - Modal Membros
        const modal = document.getElementById('membro-detalhes-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalContent = document.getElementById('membro-detalhes-conteudo');
        const modalDeleteButton = document.getElementById('membro-delete-button');
        const modalEditButton = document.getElementById('membro-edit-button');
        let currentMembroId = null; // ID do membro selecionado no modal
        let isEditMode = false; // Controla se o modal está em modo de edição

        // Variável de estado da autenticação
        let isRegisterMode = false; // Controla se o formulário é de login ou cadastro

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---

        function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener(); // Configura o listener de autenticação
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                authLoading.textContent = "Erro ao conectar. Verifique o console.";
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                authLoading.style.display = 'none'; // Esconde a mensagem de "verificando"

                if (user) {
                    // Usuário está logado
                    userId = user.uid;
                    userEmailDisplay.textContent = user.email;
                    userEmailDisplayMobile.textContent = user.email;

                    authContainer.style.display = 'none'; // Esconde formulário de login
                    mainApp.style.display = 'block'; // Mostra aplicação principal

                    loadAllData(); // Carrega os dados do usuário
                } else {
                    // Usuário está deslogado
                    userId = null;
                    authContainer.style.display = 'flex'; // Mostra formulário de login
                    mainApp.style.display = 'none'; // Esconde aplicação principal

                    // Limpa dados e listeners antigos
                    clearAllTablesAndListeners();
                }
            });
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authError.textContent = ''; // Limpa erros

            if (isRegisterMode) {
                authTitle.textContent = 'Crie o seu primeiro acesso';
                authSubmitButton.textContent = 'Registar';
                toggleAuthModeLink.textContent = 'Já tem uma conta? Entre aqui.';
            } else {
                authTitle.textContent = 'Aceder à sua conta';
                authSubmitButton.textContent = 'Entrar';
                toggleAuthModeLink.textContent = 'Não tem uma conta? Crie o seu primeiro acesso.';
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = ''; // Limpa erros anteriores
            authSubmitButton.disabled = true;

            try {
                if (isRegisterMode) {
                    // Modo Registo
                    if (password.length < 6) {
                        throw new Error("A senha deve ter pelo menos 6 caracteres.");
                    }
                    await createUserWithEmailAndPassword(auth, email, password);
                    // O onAuthStateChanged tratará da exibição do app
                } else {
                    // Modo Login
                    await signInWithEmailAndPassword(auth, email, password);
                    // O onAuthStateChanged tratará da exibição do app
                }
            } catch (error) {
                console.error("Erro de autenticação:", error);
                authError.textContent = getAuthErrorMessage(error.code);
            } finally {
                authSubmitButton.disabled = false;
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Email inválido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Email ou senha incorretos.';
                case 'auth/email-already-in-use':
                    return 'Este email já está a ser utilizado.';
                case 'auth/weak-password':
                    return 'A senha é muito fraca. (Mín. 6 caracteres)';
                default:
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // O onAuthStateChanged tratará da exibição da tela de login
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        }

        // --- CARREGAMENTO DE DADOS (FIRESTORE) ---

        function loadAllData() {
            if (!userId) return; // Garante que temos um ID de usuário

            // Limpa dados e listeners antigos (caso seja um login diferente)
            clearAllTablesAndListeners();

            // Inicia novos listeners
            listenToMembros();
            listenToDizimos();
            listenToFinanceiro();
        }

        function clearAllTablesAndListeners() {
            // Para os listeners antigos
            unsubMembros();
            unsubDizimos();
            unsubFinanceiro();

            // Limpa listas locais
            todosMembros = [];
            todosDizimos = [];
            todosFinanceiro = [];

            // Limpa tabelas na UI
            membrosTabela.innerHTML = '';
            dizimoMembroSelect.innerHTML = '<option value="">Anônimo / Não se aplica</option>';
            dizimoMembroNovoSelect.innerHTML = '<option value="">Selecione o Membro</option>';
            ofertaMembroNovoSelect.innerHTML = '<option value="">Anônimo / Não se aplica</option>';
            dizimosTabela.innerHTML = '';
            ofertasTabela.innerHTML = '';
            financeiroTabela.innerHTML = '';
        }

        // Listener para MEMBROS
        function listenToMembros() {
            const q = query(collection(db, `users/${userId}/membros`));
            unsubMembros = onSnapshot(q, (snapshot) => {
                todosMembros = [];
                snapshot.forEach((doc) => {
                    todosMembros.push({ id: doc.id, ...doc.data() });
                });
                // Ordena por nome
                todosMembros.sort((a, b) => a.nome.localeCompare(b.nome));
                renderMembros();
                updateDashboard();
            }, (error) => {
                console.error("Erro ao ouvir membros:", error.message);
            });
        }

        // Listener para DÍZIMOS/OFERTAS
        function listenToDizimos() {
            const q = query(collection(db, `users/${userId}/dizimos`));
            unsubDizimos = onSnapshot(q, (snapshot) => {
                todosDizimos = [];
                snapshot.forEach((doc) => {
                    todosDizimos.push({ id: doc.id, ...doc.data() });
                });
                renderRelatorioDizimos(); // Atualiza tabelas de dízimos/ofertas
                updateDashboard(); // Atualiza dashboard
            }, (error) => {
                console.error("Erro ao ouvir dízimos:", error.message);
            });
        }

        // Listener para FINANCEIRO
        function listenToFinanceiro() {
            const q = query(collection(db, `users/${userId}/financeiro`));
            unsubFinanceiro = onSnapshot(q, (snapshot) => {
                todosFinanceiro = [];
                snapshot.forEach((doc) => {
                    todosFinanceiro.push({ id: doc.id, ...doc.data() });
                });
                renderFinanceiro();
                updateDashboard();
            }, (error) => {
                console.error("Erro ao ouvir financeiro:", error.message);
            });
        }

        // --- RENDERIZAÇÃO (ATUALIZAÇÃO DA UI) ---

        // Renderiza a tabela de membros e o select de dízimos
        function renderMembros() {
            membrosTabela.innerHTML = ''; // Limpa tabela
            dizimoMembroSelect.innerHTML = '<option value="">Anônimo / Não se aplica</option>'; // Limpa select

            // Limpa os novos selects
            dizimoMembroNovoSelect.innerHTML = '<option value="">Selecione o Membro</option>';
            ofertaMembroNovoSelect.innerHTML = '<option value="">Anônimo / Não se aplica</option>';

            if (todosMembros.length === 0) {
                membrosTabela.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum membro cadastrado.</td></tr>';
            }

            todosMembros.forEach(membro => {
                // Adiciona na Tabela
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#" data-id="${membro.id}" class="text-indigo-600 hover:text-indigo-900 font-medium modal-trigger">${membro.nome}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${membro.telefone || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${membro.funcao || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="#" data-id="${membro.id}" class="text-red-600 hover:text-red-900 delete-membro-quick">Excluir</a>
                    </td>
                `;
                membrosTabela.appendChild(tr);

                // Adiciona no Select
                const option = document.createElement('option');
                option.value = membro.id;
                option.textContent = membro.nome;
                dizimoMembroSelect.appendChild(option);

                // Adiciona no Select (Dízimo)
                const optionDizimo = document.createElement('option');
                optionDizimo.value = membro.id;
                optionDizimo.textContent = membro.nome;
                dizimoMembroNovoSelect.appendChild(optionDizimo);

                // Adiciona no Select (Oferta)
                const optionOferta = document.createElement('option');
                optionOferta.value = membro.id;
                optionOferta.textContent = membro.nome;
                ofertaMembroNovoSelect.appendChild(optionOferta.cloneNode(true));
            });
        }

        // Renderiza as tabelas de Dízimos e Ofertas (Relatório Mensal)
        function renderRelatorioDizimos() {
            const mes = parseInt(relatorioMesSelect.value);
            const ano = parseInt(relatorioAnoInput.value);

            const mesDizimo = parseInt(relatorioMesDizimo.value);
            const anoDizimo = parseInt(relatorioAnoDizimo.value);

            if (isNaN(mesDizimo) || isNaN(anoDizimo)) {
                return; // Não renderiza se mês/ano não estiverem definidos
            }

            dizimosTabela.innerHTML = '';
            ofertasTabela.innerHTML = '';

            const dizimistasDoMes = todosDizimos
                .filter(d => {
                    const data = d.data.toDate();
                    return data.getMonth() === mesDizimo && data.getFullYear() === anoDizimo && d.tipo === 'Dízimo';
                })
                .sort((a, b) => a.data.toDate() - b.data.toDate()); // Ordena por data
            
            // Renderiza Dizimistas
            if (dizimistasDoMes.length === 0) {
                dizimosTabela.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum dízimo registrado este mês.</td></tr>';
            }
            dizimistasDoMes.forEach(dizimo => {
                const membro = todosMembros.find(m => m.id === dizimo.membroId);
                const nomeMembro = membro ? membro.nome : 'Anônimo';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(dizimo.data.toDate())}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nomeMembro}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${dizimo.valor.toFixed(2)}</td>
                `;
                dizimosTabela.appendChild(tr);
            });

            // Renderiza Ofertas
            if (ofertasDoMes.length === 0) {
                ofertasTabela.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhuma outra entrada registrada este mês.</td></tr>';
            }
            ofertasDoMes.forEach(oferta => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(oferta.data.toDate())}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${oferta.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${oferta.descricao || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${oferta.valor.toFixed(2)}</td>
                `;
                ofertasTabela.appendChild(tr);
            });
        }

        function renderRelatorioOfertas() {
            const mesOferta = parseInt(relatorioMesOferta.value);
            const anoOferta = parseInt(relatorioAnoOferta.value);

            if (isNaN(mesOferta) || isNaN(anoOferta)) {
                return; 
            }
            
            ofertasTabela.innerHTML = '';

            const ofertasDoMes = todosDizimos
                .filter(d => {
                    const data = d.data.toDate();
                    return data.getMonth() === mesOferta && data.getFullYear() === anoOferta && d.tipo !== 'Dízimo';
                })
                .sort((a, b) => a.data.toDate() - b.data.toDate()); // Ordena por data

            // Renderiza Ofertas
            if (ofertasDoMes.length === 0) {
                ofertasTabela.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhuma outra entrada registrada este mês.</td></tr>';
            }
            ofertasDoMes.forEach(oferta => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(oferta.data.toDate())}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${oferta.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${oferta.descricao || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${oferta.valor.toFixed(2)}</td>
                `;
                ofertasTabela.appendChild(tr);
            });
        }

        // Renderiza tabela financeira e calcula saldo
        function renderFinanceiro() {
            financeiroTabela.innerHTML = '';
            let saldo = 0;

            // Ordena por data (mais recente primeiro)
            const lancamentosOrdenados = [...todosFinanceiro].sort((a, b) => b.data.toDate() - a.data.toDate());

            if (lancamentosOrdenados.length === 0) {
                financeiroTabela.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum lançamento no caixa.</td></tr>';
            }

            lancamentosOrdenados.forEach(lancamento => {
                const valor = parseFloat(lancamento.valor);
                let valorFormatado = '';

                if (lancamento.tipo === 'entrada') {
                    saldo += valor;
                    valorFormatado = `<span class="text-green-600 font-medium">+ R$ ${valor.toFixed(2)}</span>`;
                } else { // 'saida'
                    saldo -= valor;
                    valorFormatado = `<span class="text-red-600 font-medium">- R$ ${valor.toFixed(2)}</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(lancamento.data.toDate())}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lancamento.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${valorFormatado}</td>
                `;
                financeiroTabela.appendChild(tr);
            });

            // Atualiza o saldo
            financeiroSaldo.textContent = `R$ ${saldo.toFixed(2)}`;
            financeiroSaldo.className = `text-2xl font-bold ${saldo >= 0 ? 'text-gray-900' : 'text-red-600'}`;
            dashboardSaldo.textContent = `R$ ${saldo.toFixed(2)}`; // Atualiza dashboard
        }

        // Atualiza os cards do Dashboard
        function updateDashboard() {
            // Saldo (já atualizado pelo renderFinanceiro)
            // Total de Membros
            dashboardMembros.textContent = todosMembros.length;

            // Entradas (Mês Atual)
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const entradasMes = todosDizimos
                .filter(d => {
                    const data = d.data.toDate();
                    return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                })
                .reduce((acc, d) => acc + d.valor, 0);

            dashboardEntradasMes.textContent = `R$ ${entradasMes.toFixed(2)}`;
        }


        // --- MANIPULAÇÃO DE FORMULÁRIOS (SALVAR DADOS) ---

        // Salvar/Editar Membro
        async function handleMembroFormSubmit(e) {
            e.preventDefault();
            const nome = document.getElementById('membro-nome').value;
            const telefone = document.getElementById('membro-telefone').value;
            const email = document.getElementById('membro-email').value;
            const dataNascimento = document.getElementById('membro-data-nascimento').value;
            const dataBatismo = document.getElementById('membro-data-batismo').value;
            const funcao = document.getElementById('membro-funcao').value;
            const endereco = document.getElementById('membro-endereco').value;

            const membroData = {
                nome,
                telefone,
                email,
                dataNascimento,
                dataBatismo,
                funcao,
                endereco
            };

            try {
                if (isEditMode && currentMembroId) {
                    // Modo Edição
                    const docRef = doc(db, `users/${userId}/membros`, currentMembroId);
                    await setDoc(docRef, membroData); // setDoc substitui o documento
                    showFormMessage(membroFormMensagem, "Membro atualizado com sucesso!");
                    closeModal();
                } else {
                    // Modo Cadastro
                    await addDoc(collection(db, `users/${userId}/membros`), membroData);
                    showFormMessage(membroFormMensagem, "Membro salvo com sucesso!");
                    membroForm.reset(); // Limpa o formulário
                }
            } catch (error) {
                console.error("Erro ao salvar membro: ", error);
                    showFormMessage(membroFormMensagem, "Erro ao salvar membro.", true);
            }
        }

        // Salvar Dízimo/Oferta
        async function handleDizimoFormSubmit(e) {
            e.preventDefault();
            const dataInput = document.getElementById('dizimo-data').value;
            const membroId = document.getElementById('dizimo-membro').value;
            const valor = parseFloat(document.getElementById('dizimo-valor').value);
            const tipo = document.getElementById('dizimo-tipo').value;
            const descricao = document.getElementById('dizimo-descricao').value;

            if (isNaN(valor) || valor <= 0) {
                showFormMessage(dizimoFormMensagem, "Valor inválido.", true);
                return;
            }

            const dizimoData = {
                data: Timestamp.fromDate(new Date(dataInput.replace(/-/g, '\/'))), // Corrige formato de data para JS
                membroId: membroId || null,
                valor: valor,
                tipo: tipo,
                descricao: descricao
            };

            // Usar um WriteBatch para garantir que ambas as operações funcionem ou falhem juntas
            const batch = writeBatch(db);

            try {
                // 1. Adiciona o registro em "dizimos"
                const dizimoRef = doc(collection(db, `users/${userId}/dizimos`));
                batch.set(dizimoRef, dizimoData);

                // 2. Adiciona o registro correspondente em "financeiro"
                const financeiroRef = doc(collection(db, `users/${userId}/financeiro`));
                batch.set(financeiroRef, {
                    data: dizimoData.data,
                    descricao: `${tipo} - ${descricao || (todosMembros.find(m => m.id === membroId)?.nome || 'Anônimo')}`,
                    valor: dizimoData.valor,
                    tipo: 'entrada' // Toda entrada de dízimo/oferta é uma 'entrada' no financeiro
                });

                await batch.commit(); // Executa as duas operações

                showFormMessage(dizimoFormMensagem, "Entrada registrada com sucesso!");
                dizimoForm.reset();
                document.getElementById('dizimo-data').value = new Date().toISOString().split('T')[0]; // Reseta data para hoje

            } catch (error) {
                console.error("Erro ao registrar entrada: ", error);
                showFormMessage(dizimoFormMensagem, "Erro ao registrar entrada.", true);
            }
        }

        // Salvar Dízimo (Novo Formulário)
        async function handleDizimoNovoSubmit(e) {
            e.preventDefault();
            const dataInput = document.getElementById('dizimo-data-novo').value;
            const membroId = document.getElementById('dizimo-membro-novo').value;
            const valor = parseFloat(document.getElementById('dizimo-valor-novo').value);
            const descricao = document.getElementById('dizimo-descricao-novo').value;

            if (membroId === "") {
                showFormMessage(dizimoNovoMensagem, "Por favor, selecione um membro.", true);
                return;
            }
            if (isNaN(valor) || valor <= 0) {
                showFormMessage(dizimoNovoMensagem, "Valor inválido.", true);
                return;
            }

            const dizimoData = {
                data: Timestamp.fromDate(new Date(dataInput.replace(/-/g, '\/'))),
                membroId: membroId,
                valor: valor,
                tipo: 'Dízimo', // Hardcoded
                descricao: descricao
            };

            const batch = writeBatch(db);
            try {
                const dizimoRef = doc(collection(db, `users/${userId}/dizimos`));
                batch.set(dizimoRef, dizimoData);

                const financeiroRef = doc(collection(db, `users/${userId}/financeiro`));
                batch.set(financeiroRef, {
                    data: dizimoData.data,
                    descricao: `Dízimo - ${todosMembros.find(m => m.id === membroId)?.nome}`,
                    valor: dizimoData.valor,
                    tipo: 'entrada'
                });

                await batch.commit();
                showFormMessage(dizimoNovoMensagem, "Dízimo registrado com sucesso!");
                formDizimoNovo.reset();
                document.getElementById('dizimo-data-novo').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error("Erro ao registrar dízimo: ", error);
                showFormMessage(dizimoNovoMensagem, "Erro ao registrar dízimo.", true);
            }
        }

        // Salvar Oferta (Novo Formulário)
        async function handleOfertaNovaSubmit(e) {
            e.preventDefault();
            const dataInput = document.getElementById('oferta-data-nova').value;
            const membroId = document.getElementById('oferta-membro-novo').value;
            const valor = parseFloat(document.getElementById('oferta-valor-novo').value);
            const tipo = document.getElementById('oferta-tipo-novo').value; // From select
            const descricao = document.getElementById('oferta-descricao-nova').value;

            if (isNaN(valor) || valor <= 0) {
                showFormMessage(ofertaNovoMensagem, "Valor inválido.", true);
                return;
            }

            const ofertaData = {
                data: Timestamp.fromDate(new Date(dataInput.replace(/-/g, '\/'))),
                membroId: membroId || null,
                valor: valor,
                tipo: tipo,
                descricao: descricao
            };

            const batch = writeBatch(db);
            try {
                const dizimoRef = doc(collection(db, `users/${userId}/dizimos`)); // Still goes to "dizimos" collection
                batch.set(dizimoRef, ofertaData);

                const financeiroRef = doc(collection(db, `users/${userId}/financeiro`));
                batch.set(financeiroRef, {
                    data: ofertaData.data,
                    descricao: `${tipo} - ${descricao || (todosMembros.find(m => m.id === membroId)?.nome || 'Anônimo')}`,
                    valor: ofertaData.valor,
                    tipo: 'entrada'
                });

                await batch.commit();
                showFormMessage(ofertaNovoMensagem, "Entrada registrada com sucesso!");
                formOfertaNova.reset();
                document.getElementById('oferta-data-nova').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error("Erro ao registrar entrada: ", error);
                showFormMessage(ofertaNovoMensagem, "Erro ao registrar entrada.", true);
            }
        }

        // Salvar Lançamento Financeiro
        async function handleFinanceiroFormSubmit(e) {
            e.preventDefault();
            const dataInput = document.getElementById('financeiro-data').value;
            const descricao = document.getElementById('financeiro-descricao').value;
            const valor = parseFloat(document.getElementById('financeiro-valor').value);
            const tipo = document.getElementById('financeiro-tipo').value;

            if (isNaN(valor) || valor <= 0) {
                showFormMessage(financeiroFormMensagem, "Valor inválido.", true);
                return;
            }

            const financeiroData = {
                data: Timestamp.fromDate(new Date(dataInput.replace(/-/g, '\/'))),
                descricao,
                valor,
                tipo
            };

            try {
                await addDoc(collection(db, `users/${userId}/financeiro`), financeiroData);
                showFormMessage(financeiroFormMensagem, "Lançamento salvo com sucesso!");
                financeiroForm.reset();
                document.getElementById('financeiro-data').value = new Date().toISOString().split('T')[0]; // Reseta data para hoje
            } catch (error) {
                console.error("Erro ao salvar lançamento: ", error);
                showFormMessage(financeiroFormMensagem, "Erro ao salvar lançamento.", true);
            }
        }

        // Excluir Membro (Ação Rápida ou Pelo Modal)
        async function deleteMembro(membroId) {
            if (!confirm("Tem certeza que deseja excluir este membro? Esta ação não pode ser desfeita.")) {
                return;
            }
            try {
                await deleteDoc(doc(db, `users/${userId}/membros`, membroId));
                closeModal(); // Fecha o modal se estiver aberto
                // O listener onSnapshot atualizará a tabela automaticamente
            } catch (error) {
                console.error("Erro ao excluir membro: ", error);
                alert("Erro ao excluir membro.");
            }
        }


        // --- MODAL DE DETALHES DO MEMBRO ---

        function openModal(membroId) {
            const membro = todosMembros.find(m => m.id === membroId);
            if (!membro) return;

            currentMembroId = membroId;
            isEditMode = false; // Reseta para modo visualização
            modal.classList.add('flex');
            showMembroDetails(membro);
        }

        function closeModal() {
            modal.classList.remove('flex');
            currentMembroId = null;
            isEditMode = false;
        }

        // Mostra os detalhes do membro no modal (modo visualização)
        function showMembroDetails(membro) {
            modalContent.innerHTML = `
                <p><strong>Nome:</strong> ${membro.nome || ''}</p>
                <p><strong>Telefone:</strong> ${membro.telefone || ''}</p>
                <p><strong>Email:</strong> ${membro.email || ''}</p>
                <p><strong>Data de Nascimento:</strong> ${membro.dataNascimento || ''}</p>
                <p><strong>Data de Batismo:</strong> ${membro.dataBatismo || ''}</p>
                <p><strong>Função / Ministério:</strong> ${membro.funcao || ''}</p>
                <p><strong>Endereço:</strong><br>${membro.endereco ? membro.endereco.replace(/\n/g, '<br>') : ''}</p>
            `;
            modalEditButton.textContent = 'Editar';
            modalDeleteButton.style.display = 'inline-flex';
        }

        // Mostra o formulário de edição do membro no modal (modo edição)
        function showMembroEditForm(membro) {
            modalContent.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome:</label>
                        <input type="text" id="modal-membro-nome" value="${membro.nome || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Telefone:</label>
                        <input type="tel" id="modal-membro-telefone" value="${membro.telefone || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="modal-membro-email" value="${membro.email || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data de Nascimento:</label>
                        <input type="date" id="modal-membro-data-nascimento" value="${membro.dataNascimento || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data de Batismo:</label>
                        <input type="date" id="modal-membro-data-batismo" value="${membro.dataBatismo || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Função / Ministério:</label>
                        <input type="text" id="modal-membro-funcao" value="${membro.funcao || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Endereço:</label>
                        <textarea id="modal-membro-endereco" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">${membro.endereco || ''}</textarea>
                    </div>
                </div>
            `;
            modalEditButton.textContent = 'Salvar Alterações';
            modalDeleteButton.style.display = 'none'; // Oculta o botão de excluir no modo de edição
        }

        // Ação do botão Editar/Salvar no modal
        async function handleModalEditClick() {
            if (isEditMode) {
                // Se está em modo edição, Tenta salvar
                const membroData = {
                    nome: document.getElementById('modal-membro-nome').value,
                    telefone: document.getElementById('modal-membro-telefone').value,
                    email: document.getElementById('modal-membro-email').value,
                    dataNascimento: document.getElementById('modal-membro-data-nascimento').value,
                    dataBatismo: document.getElementById('modal-membro-data-batismo').value,
                    funcao: document.getElementById('modal-membro-funcao').value,
                    endereco: document.getElementById('modal-membro-endereco').value
                };

                try {
                    const docRef = doc(db, `users/${userId}/membros`, currentMembroId);
                    await setDoc(docRef, membroData);
                    closeModal();
                    // O listener onSnapshot atualizará a UI
                } catch (error) {
                    console.error("Erro ao atualizar membro:", error);
                    alert("Erro ao atualizar membro.");
                }
            } else {
                // Se está em modo visualização, entra em modo edição
                const membro = todosMembros.find(m => m.id === currentMembroId);
                if (membro) {
                    isEditMode = true;
                    showMembroEditForm(membro);
                }
            }
        }


        // --- NAVEGAÇÃO POR ABAS ---

        function setupTabs() {
            // Define os títulos de cada aba
            const tabTitles = {
                'tab-dashboard': 'Dashboard',
                'tab-cadastrar-membro': 'Cadastrar Novo Membro',
                'tab-visualizar-membros': 'Visualizar Membros',
                'tab-dizimos': 'Dízimos e Ofertas',
                'tab-dizimos-reg': 'Dízimos',
                'tab-ofertas-reg': 'Ofertas e Outras Entradas',
                'tab-financeiro': 'Financeiro (Caixa)'
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');

                    // Atualiza Header
                    headerTitle.textContent = tabTitles[targetTab] || 'Dashboard';

                    // Atualiza botões (Active)
                    tabButtons.forEach(btn => {
                        if (btn.getAttribute('data-tab') === targetTab) {
                            btn.classList.add('active');
                            // Ajusta classes mobile/desktop
                            btn.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                            btn.classList.add('bg-gray-900', 'text-white');
                        } else {
                            btn.classList.remove('active', 'bg-gray-900', 'text-white');
                            btn.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                        }
                    });

                    // Atualiza Conteúdo (Active)
                    tabContents.forEach(content => {
                        content.style.display = content.id === targetTab ? 'block' : 'none';
                    });
                });
            });

            // Ajuste inicial para botões mobile/desktop (não-abas)
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.classList.contains('active')) {
                    button.classList.add('bg-gray-900', 'text-white');
                } else {
                    button.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                }
                // Classes comuns a todos
                button.classList.add('px-3', 'py-2', 'rounded-md', 'text-sm', 'font-medium', 'block', 'md:inline-block', 'border-b-2', 'border-transparent', 'md:border-b-0');
            });
        }


        // --- FUNÇÕES UTILITÁRIAS ---

        // Formata data para dd/mm/aaaa
        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('pt-BR');
        }

        // Mostra mensagem de sucesso/erro nos formulários
        function showFormMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'text-sm text-red-600' : 'text-sm text-green-600';
            setTimeout(() => {
                element.textContent = '';
            }, 3000);
        }

        // Preenche os seletores de data para o relatório de dízimos
        function setupRelatorioSelectors() {
            const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const hoje = new Date();
            const mesAtual = hoje.getMonth(); // 0-11
            const anoAtual = hoje.getFullYear();

            relatorioMesSelect.innerHTML = '';
            meses.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = mes;
                if (index === mesAtual) {
                    option.selected = true;
                }
                relatorioMesSelect.appendChild(option);
            });

            relatorioAnoInput.value = anoAtual;

            // Setup for Dízimo Selectors
            relatorioMesDizimo.innerHTML = '';
            meses.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = mes;
                if (index === mesAtual) option.selected = true;
                relatorioMesDizimo.appendChild(option);
            });
            relatorioAnoDizimo.value = anoAtual;

            // Setup for Oferta Selectors
            relatorioMesOferta.innerHTML = '';
            meses.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = mes;
                if (index === mesAtual) option.selected = true;
                relatorioMesOferta.appendChild(option.cloneNode(true));
            });
            relatorioAnoOferta.value = anoAtual;

            // Adiciona listeners para atualizar o relatório quando os seletores mudarem
            relatorioMesSelect.addEventListener('change', renderRelatorioDizimos);
            relatorioAnoInput.addEventListener('change', renderRelatorioDizimos);

            // Add listeners for Dízimo
            relatorioMesDizimo.addEventListener('change', renderRelatorioDizimos);
            relatorioAnoDizimo.addEventListener('change', renderRelatorioDizimos);

            // Add listeners for Oferta
            relatorioMesOferta.addEventListener('change', renderRelatorioOfertas);
            relatorioAnoOferta.addEventListener('change', renderRelatorioOfertas);
        }


        // --- EVENT LISTENERS GLOBAIS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Configura Firebase e Autenticação
            setupFirebase();
            toggleAuthModeLink.addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', handleAuthFormSubmit);
            logoutButton.addEventListener('click', handleLogout);
            logoutButtonMobile.addEventListener('click', handleLogout);

            // Configura Navegação
            setupTabs();
            setupRelatorioSelectors();

            // Seta datas padrão nos formulários
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dizimo-data').value = today;
            document.getElementById('dizimo-data-novo').value = today;
            document.getElementById('oferta-data-nova').value = today;
            document.getElementById('financeiro-data').value = today;

            // Formulários
            membroForm.addEventListener('submit', handleMembroFormSubmit);
            dizimoForm.addEventListener('submit', handleDizimoFormSubmit);
            formDizimoNovo.addEventListener('submit', handleDizimoNovoSubmit);
            formOfertaNova.addEventListener('submit', handleOfertaNovaSubmit);
            financeiroForm.addEventListener('submit', handleFinanceiroFormSubmit);

            // Modal de Membros
            modalCloseButton.addEventListener('click', closeModal);
            modalDeleteButton.addEventListener('click', () => deleteMembro(currentMembroId));
            modalEditButton.addEventListener('click', handleModalEditClick);

            // Event delegation para cliques na tabela (Abrir Modal, Excluir Rápido)
            membrosTabela.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target;

                if (target.classList.contains('modal-trigger')) {
                    openModal(target.getAttribute('data-id'));
                }
                if (target.classList.contains('delete-membro-quick')) {
                    deleteMembro(target.getAttribute('data-id'));
                }
            });

        });
    </script>

    <!-- Script Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Espera o DOM estar pronto e então carrega os ícones
            // Isso garante que os elementos SVG já existem
            try {
                lucide.createIcons();
            } catch (error) {
                console.error("Erro ao criar ícones Lucide:", error);
            }
        });
    </sCRIPT>

</body>

</html>


