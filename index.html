<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"> <!-- Corrigido de UTF-T para UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão da Igreja - Membros e Financeiro</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a biblioteca de ícones Lucide -->
    <!-- <script type="module" src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script> --> <!-- Removido: Esta é a biblioteca para React -->
    <!-- <script src="https://unpkg.com/lucide-icons@latest"></script> --> <!-- Movido para o final do <body> -->
    <style>
        /* Fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Um cinza-azulado muito claro */
        }
        /* Estilo para a aba ativa */
        .tab-active {
            border-bottom-color: #3b82f6; /* Azul */
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-7xl p-4 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-700">Sistema de Gestão da Igreja</h1>
            <div class="text-sm text-gray-600 mt-2 md:mt-0">
                Seu ID de usuário: <span id="userIdDisplay" class="font-mono bg-gray-200 px-2 py-1 rounded">Carregando...</span>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <div class="mb-6 border-b border-gray-300">
            <nav class="flex -mb-px space-x-6 overflow-x-auto" aria-label="Tabs">
                <button id="tab-cad-membro" onclick="changeTab('cad-membro')" class="tab-button tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2">
                    <i data-lucide="user-plus"></i>
                    <span>Cadastrar Membro</span>
                </button>
                <button id="tab-vis-membros" onclick="changeTab('vis-membros')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2">
                    <i data-lucide="users"></i>
                    <span>Visualizar Membros</span>
                </button>
                <button id="tab-dizimos" onclick="changeTab('dizimos')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2">
                    <i data-lucide="hand-heart"></i>
                    <span>Dízimos e Ofertas</span>
                </button>
                <button id="tab-financeiro" onclick="changeTab('financeiro')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2">
                    <i data-lucide="dollar-sign"></i>
                    <span>Financeiro (Caixa)</span>
                </button>
            </nav>
        </div>

        <!-- Mensagem de Status -->
        <div id="statusMessage" class="hidden mb-4 p-4 rounded-md text-sm"></div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- ======================= -->
            <!-- ABA DE CADASTRO MEMBROS -->
            <!-- ======================= -->
            <section id="content-cad-membro" class="content-section space-y-6">
                <div class="max-w-xl mx-auto">
                    <!-- Formulário de Novo Membro -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-blue-600">Novo Membro</h2>
                        <form id="formMembro" class="space-y-4">
                            <div>
                                <label for="membroNome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                                <input type="text" id="membroNome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="membroTelefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                                <input type="tel" id="membroTelefone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="membroEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="membroEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="membroNascimento" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
                                <input type="date" id="membroNascimento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                             <div>
                                <label for="membroBatismo" class="block text-sm font-medium text-gray-700">Data de Batismo</label>
                                <input type="date" id="membroBatismo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                             <div>
                                <label for="membroFuncao" class="block text-sm font-medium text-gray-700">Função / Ministério</label>
                                <input type="text" id="membroFuncao" placeholder="Ex: Pastor, Diácono, Membro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="membroEndereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                                <textarea id="membroEndereco" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="Rua, Número, Bairro, Cidade - UF"></textarea>
                            </div>
                            <button type="submit" class="w-full flex justify-center items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                <i data-lucide="user-plus"></i>
                                <span>Adicionar Membro</span>
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- ======================= -->
            <!-- ABA DE VISUALIZAR MEMBROS -->
            <!-- ======================= -->
            <section id="content-vis-membros" class="content-section hidden space-y-6">
                <!-- Tabela de Membros -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-blue-600">Membros Cadastrados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Função</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaMembros" class="bg-white divide-y divide-gray-200">
                                    <!-- Linhas de membros serão inseridas aqui pelo JS -->
                                    <tr><td colspan="5" class="p-4 text-center text-gray-500">Carregando membros...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================= -->
            <!-- ABA DE DÍZIMOS        -->
            <!-- ======================= -->
            <section id="content-dizimos" class="content-section hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Formulário de Novo Dízimo/Oferta -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">Registrar Dízimo / Oferta</h2>
                        <form id="formDizimo" class="space-y-4">
                            <div>
                                <label for="dizimoMembro" class="block text-sm font-medium text-gray-700">Membro</label>
                                <select id="dizimoMembro" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2">
                                    <option value="">Selecione um membro...</option>
                                    <!-- Opções de membros serão inseridas aqui pelo JS -->
                                </select>
                            </div>
                            <div>
                                <label for="dizimoValor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="number" id="dizimoValor" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="dizimoData" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="dizimoData" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2">
                            </div>
                             <div>
                                <label for="dizimoDescricao" class="block text-sm font-medium text-gray-700">Descrição (Ex: Dízimo, Oferta, Evento)</label>
                                <input type="text" id="dizimoDescricao" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2" value="Dízimo">
                            </div>
                            <button type="submit" class="w-full flex justify-center items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                <i data-lucide="check"></i>
                                <span>Registrar Entrada</span>
                            </button>
                        </form>
                    </div>

                    <!-- Tabela de Registros -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">Registros de Dízimos e Ofertas</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Membro</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaDizimos" class="bg-white divide-y divide-gray-200">
                                    <!-- Linhas de dízimos serão inseridas aqui pelo JS -->
                                    <tr><td colspan="5" class="p-4 text-center text-gray-500">Carregando registros...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================= -->
            <!-- ABA FINANCEIRO (CAIXA) -->
            <!-- ======================= -->
            <section id="content-financeiro" class="content-section hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Lançamento (Entrada/Saída) -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-indigo-600">Novo Lançamento no Caixa</h2>
                        <form id="formFinanceiro" class="space-y-4">
                            <div>
                                <label for="financeiroData" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="financeiroData" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="financeiroDescricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                                <input type="text" id="financeiroDescricao" required placeholder="Ex: Aluguel, Conta de Luz, Oferta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="financeiroTipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                                <select id="financeiroTipo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída (Despesa)</option>
                                </select>
                            </div>
                            <div>
                                <label for="financeiroValor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="number" id="financeiroValor" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <button type="submit" class="w-full flex justify-center items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                <i data-lucide="plus-circle"></i>
                                <span>Lançar no Caixa</span>
                            </button>
                        </form>
                    </div>

                    <!-- Tabela Financeiro e Saldo -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md space-y-6">
                        <!-- Saldo -->
                        <div>
                            <h2 class="text-xl font-semibold mb-4 text-indigo-600">Balanço Financeiro</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-green-100 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-green-800">Total de Entradas</div>
                                    <div id="totalEntradas" class="text-2xl font-bold text-green-600">R$ 0,00</div>
                                </div>
                                <div class="bg-red-100 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-red-800">Total de Saídas</div>
                                    <div id="totalSaidas" class="text-2xl font-bold text-red-600">R$ 0,00</div>
                                </div>
                                <div class="bg-blue-100 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-blue-800">Saldo Atual</div>
                                    <div id="saldoAtual" class="text-2xl font-bold text-blue-600">R$ 0,00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabela de Lançamentos -->
                        <div>
                            <h2 class="text-xl font-semibold mb-4 text-indigo-600">Extrato do Caixa</h2>
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaFinanceiro" class="bg-white divide-y divide-gray-200">
                                        <!-- Linhas de lançamentos serão inseridas aqui pelo JS -->
                                        <tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando lançamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Exclusão (Genérico) -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Exclusão</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
                </div>
                <div class="items-center px-4 py-3 space-x-4">
                    <button id="modalConfirmDelete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Excluir
                    </button>
                    <button id="modalCancelDelete" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Membro -->
    <div id="memberDetailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl leading-6 font-medium text-gray-900">Detalhes do Membro</h3>
                 <button id="modalCloseDetails" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                 </button>
            </div>
            <!-- Conteúdo dos Detalhes -->
            <div id="memberDetailContent" class="space-y-1 border-t border-b divide-y divide-gray-200">
                <!-- Conteúdo será preenchido pelo JS -->
                <p class="text-center text-gray-500 py-4">Carregando...</p>
            </div>
            <div class="items-center px-4 py-3 mt-4 text-right">
                <button id="modalCloseDetailsBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <!-- ======================= -->
    <!-- SCRIPTS                 -->
    <!-- ======================= -->

    <!-- Carrega o Lucide (deve vir antes do script module que o chama) -->
    <!-- <script src="https://unpkg.com/lucide-icons@latest"></script> --> <!-- Biblioteca incorreta -->
    <script src="https://unpkg.com/lucide@latest"></script> <!-- Biblioteca correta que expõe o objeto 'lucide' -->

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS GLOBAIS ---
        let db, auth;
        let userId; // ID do usuário autenticado
        let appId;  // ID da aplicação (vem do ambiente)
        
        let unsubMembros = null;    // Função para parar de ouvir membros
        let unsubDizimos = null;    // Função para parar de ouvir dízimos
        let unsubFinanceiro = null; // Função para parar de ouvir financeiro

        let listaMembrosCache = []; // Cache para popular dropdowns

        // --- INICIALIZAÇÃO ---

        // Configuração e Inicialização do Firebase
        async function setupFirebase() {
            try {
                // 1. Obter Configs do Ambiente
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig.apiKey) {
                    showStatus("Erro crítico: Configuração do Firebase não encontrada.", "error");
                    console.error("Configuração do Firebase não carregada.");
                    return;
                }

                // 2. Inicializar App e Serviços
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Para logs detalhados no console

                // 3. Autenticação
                setupAuthListener();
                
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    console.log("Autenticando com Custom Token...");
                    await signInWithCustomToken(auth, token);
                } else {
                    console.log("Autenticando anonimamente...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                showStatus(`Erro ao conectar: ${error.message}`, "error");
            }
        }

        // Observador de Autenticação
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Usuário autenticado:", user.uid);
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    
                    // Usuário está logado, podemos carregar os dados
                    loadAllData();
                } else {
                    console.log("Usuário deslogado.");
                    userId = null;
                    document.getElementById('userIdDisplay').textContent = "Ninguém logado";
                    // Limpar dados se o usuário deslogar
                    cleanupListeners();
                    clearAllTables();
                }
            });
        }

        // Carrega todos os dados (chamado após auth)
        function loadAllData() {
            if (!db || !userId) {
                console.warn("Firestore ou UserID não estão prontos.");
                return;
            }
            
            // Limpa listeners antigos (caso de reconexão)
            cleanupListeners();
            
            // Inicia novos listeners
            listenToMembros();
            listenToDizimos();
            listenToFinanceiro();
        }

        // Limpa todos os listeners onSnapshot
        function cleanupListeners() {
            if (unsubMembros) unsubMembros();
            if (unsubDizimos) unsubDizimos();
            if (unsubFinanceiro) unsubFinanceiro();
        }

        // Limpa tabelas
        function clearAllTables() {
            renderMembros([]);
            renderDizimos([]);
            renderFinanceiro([]); // Adicionado
            updateDropdownMembros([]);
            updateSaldo(0, 0); // Adicionado
        }

        // --- NAVEGAÇÃO POR ABAS ---
        window.changeTab = (tabName) => {
            // Oculta todos os conteúdos
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            // Remove classe ativa de todos os botões
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active', 'text-blue-600');
                button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // Mostra o conteúdo da aba selecionada
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Adiciona classe ativa ao botão selecionado
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }

        // --- MENSAGENS DE STATUS ---
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            if (type === 'success') {
                statusEl.className = 'mb-4 p-4 rounded-md text-sm bg-green-100 text-green-700';
            } else if (type === 'error') {
                statusEl.className = 'mb-4 p-4 rounded-md text-sm bg-red-100 text-red-700';
            } else {
                 statusEl.className = 'mb-4 p-4 rounded-md text-sm bg-blue-100 text-blue-700';
            }

            // Esconde a mensagem após 5 segundos
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        // --- FORMATAÇÃO ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatDate = (date) => {
            // Converte string YYYY-MM-DD para DD/MM/YYYY
            if (typeof date === 'string' && date.includes('-')) {
                const parts = date.split('-');
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            // Converte Timestamp do Firebase
            if (date && typeof date.toDate === 'function') {
                return date.toDate().toLocaleDateString('pt-BR');
            }
            // Fallback para datas já formatadas ou nulas
            if (typeof date === 'string') {
                return date;
            }
            return 'Data Inválida';
        };

        // --- GESTÃO DE MEMBROS ---
        
        // Caminho da coleção de Membros
        const getMembrosCollection = () => collection(db, `artifacts/${appId}/users/${userId}/membros`);
        
        // Listener (onSnapshot) para Membros
        function listenToMembros() {
            const q = query(getMembrosCollection()); // Adicionar orderBy aqui se necessário
            unsubMembros = onSnapshot(q, (snapshot) => {
                const membros = [];
                snapshot.forEach((doc) => {
                    membros.push({ id: doc.id, ...doc.data() });
                });
                // Ordena por nome no cliente (Evita erro de índice no Firestore)
                membros.sort((a, b) => a.nome.localeCompare(b.nome));
                
                listaMembrosCache = membros; // Atualiza o cache
                renderMembros(membros);
                updateDropdownMembros(membros);
            }, (error) => {
                console.error("Erro ao ouvir membros:", error);
                showStatus("Erro ao carregar membros.", "error");
            });
        }

        // Renderiza tabela de Membros
        function renderMembros(membros) {
            const tbody = document.getElementById('tabelaMembros');
            if (membros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum membro cadastrado.</td></tr>';
                return;
            }
            
            tbody.innerHTML = membros.map(m => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer" onclick="showMemberDetails('${m.id}')">
                            ${m.nome}
                        </div>
                        <div class="text-sm text-gray-500">Nasc: ${m.nascimento ? formatDate(m.nascimento) : 'N/A'}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.funcao || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.telefone || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${m.email || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <button onclick="confirmDelete('${m.id}', 'membro')" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons(); // Recria ícones
        }

        // Atualiza o <select> de membros na aba Dízimos
        function updateDropdownMembros(membros) {
            const select = document.getElementById('dizimoMembro');
            select.innerHTML = '<option value="">Selecione um membro...</option>'; // Reseta
            membros.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.nome;
                // Guarda o nome no dataset para referência futura
                option.dataset.nome = m.nome; 
                select.appendChild(option);
            });
        }
        
        // Handler do formulário de Membro
        document.getElementById('formMembro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('membroNome').value;
            const telefone = document.getElementById('membroTelefone').value;
            const email = document.getElementById('membroEmail').value;
            const nascimento = document.getElementById('membroNascimento').value;
            const batismo = document.getElementById('membroBatismo').value;
            const funcao = document.getElementById('membroFuncao').value;
            const endereco = document.getElementById('membroEndereco').value;

            if (!nome) {
                showStatus("O nome do membro é obrigatório.", "error");
                return;
            }

            try {
                await addDoc(getMembrosCollection(), {
                    nome,
                    telefone,
                    email,
                    nascimento: nascimento || null, // Salva nulo se vazio
                    batismo: batismo || null, // Salva nulo se vazio
                    funcao: funcao || 'Membro', // Salva 'Membro' se estiver vazio
                    endereco: endereco || null, // Salva nulo se vazio
                    criadoEm: Timestamp.now()
                });
                showStatus("Membro adicionado com sucesso!", "success");
                e.target.reset(); // Limpa o formulário
            } catch (error) {
                console.error("Erro ao adicionar membro:", error);
                showStatus("Erro ao salvar membro.", "error");
            }
        });

        // --- GESTÃO DE DÍZIMOS ---
        
        // Caminho da coleção de Dízimos
        const getDizimosCollection = () => collection(db, `artifacts/${appId}/users/${userId}/dizimos`);
        
        // Listener (onSnapshot) para Dízimos
        function listenToDizimos() {
            const q = query(getDizimosCollection());
            unsubDizimos = onSnapshot(q, (snapshot) => {
                const dizimos = [];
                snapshot.forEach((doc) => {
                    dizimos.push({ id: doc.id, ...doc.data() });
                });
                // Ordena por data (mais recente primeiro)
                dizimos.sort((a, b) => b.data.localeCompare(a.data));
                renderDizimos(dizimos);
            }, (error) => {
                console.error("Erro ao ouvir dízimos:", error);
                showStatus("Erro ao carregar dízimos.", "error");
            });
        }
        
        // Renderiza tabela de Dízimos
        function renderDizimos(dizimos) {
            const tbody = document.getElementById('tabelaDizimos');
            if (dizimos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum registro encontrado.</td></tr>';
                return;
            }
            
            tbody.innerHTML = dizimos.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(d.data)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${d.membroNome || 'Membro não encontrado'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${d.descricao}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">${formatCurrency(d.valor)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <button onclick="confirmDelete('${d.id}', 'dizimo')" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons(); // Recria ícones
        }

        // Handler do formulário de Dízimo
        document.getElementById('formDizimo').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectMembro = document.getElementById('dizimoMembro');
            const membroId = selectMembro.value;
            const membroNome = selectMembro.options[selectMembro.selectedIndex].dataset.nome;
            const valor = parseFloat(document.getElementById('dizimoValor').value);
            const data = document.getElementById('dizimoData').value;
            const descricao = document.getElementById('dizimoDescricao').value;

            if (!membroId || !valor || !data || !descricao) {
                showStatus("Por favor, preencha todos os campos.", "error");
                return;
            }

            try {
                // 1. Adiciona o registro em 'dizimos'
                const dizimoDocRef = await addDoc(getDizimosCollection(), {
                    membroId,
                    membroNome,
                    valor,
                    data,
                    descricao,
                    criadoEm: Timestamp.now()
                });
                
                // 2. Adiciona o registro correspondente em 'financeiro' como entrada
                await addDoc(getFinanceiroCollection(), {
                    data,
                    descricao: `${descricao} - ${membroNome}`,
                    tipo: 'entrada',
                    valor,
                    criadoEm: Timestamp.now(),
                    origemDizimoId: dizimoDocRef.id // Linka ao registro de dízimo
                });

                showStatus("Dízimo/Oferta registrado com sucesso!", "success");
                e.target.reset();
                document.getElementById('dizimoData').value = new Date().toISOString().split('T')[0]; // Reseta data
                document.getElementById('dizimoDescricao').value = "Dízimo"; // Reseta descrição padrão
            } catch (error) {
                console.error("Erro ao registrar dízimo:", error);
                showStatus("Erro ao salvar o registro.", "error");
            }
        });


        // --- GESTÃO FINANCEIRA (CAIXA) ---

        // Caminho da coleção Financeiro
        const getFinanceiroCollection = () => collection(db, `artifacts/${appId}/users/${userId}/financeiro`);

        // Listener (onSnapshot) para Financeiro
        function listenToFinanceiro() {
            const q = query(getFinanceiroCollection());
            unsubFinanceiro = onSnapshot(q, (snapshot) => {
                const lancamentos = [];
                let totalEntradas = 0;
                let totalSaidas = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    lancamentos.push({ id: doc.id, ...data });

                    if (data.tipo === 'entrada') {
                        totalEntradas += data.valor;
                    } else if (data.tipo === 'saida') {
                        totalSaidas += data.valor;
                    }
                });

                // Ordena por data (mais recente primeiro)
                lancamentos.sort((a, b) => b.data.localeCompare(a.data));
                
                renderFinanceiro(lancamentos);
                updateSaldo(totalEntradas, totalSaidas);
            }, (error) => {
                console.error("Erro ao ouvir financeiro:", error);
                showStatus("Erro ao carregar o financeiro.", "error");
            });
        }

        // Renderiza tabela do Financeiro
        function renderFinanceiro(lancamentos) {
            const tbody = document.getElementById('tabelaFinanceiro');
            if (lancamentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum lançamento no caixa.</td></tr>';
                return;
            }

            tbody.innerHTML = lancamentos.map(l => {
                const isEntrada = l.tipo === 'entrada';
                const valorClasse = isEntrada ? 'text-green-600' : 'text-red-600';
                const valorPrefixo = isEntrada ? '+' : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(l.data)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${l.descricao}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${valorClasse}">
                            ${valorPrefixo} ${formatCurrency(l.valor)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="confirmDelete('${l.id}', 'financeiro')" class="text-red-600 hover:text-red-900" title="Excluir" ${l.origemDizimoId ? 'disabled' : ''}>
                                <i data-lucide="trash-2" class="w-5 h-5 ${l.origemDizimoId ? 'text-gray-400' : ''}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons(); // Recria ícones
        }

        // Atualiza o painel de Saldo
        function updateSaldo(entradas, saidas) {
            const saldo = entradas - saidas;
            document.getElementById('totalEntradas').textContent = formatCurrency(entradas);
            document.getElementById('totalSaidas').textContent = formatCurrency(saidas);
            document.getElementById('saldoAtual').textContent = formatCurrency(saldo);
            
            // Atualiza cor do saldo
            const saldoEl = document.getElementById('saldoAtual');
            saldoEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
            if (saldo > 0) {
                saldoEl.classList.add('text-green-600');
            } else if (saldo < 0) {
                saldoEl.classList.add('text-red-600');
            } else {
                saldoEl.classList.add('text-blue-600');
            }
        }

        // Handler do formulário Financeiro
        document.getElementById('formFinanceiro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('financeiroData').value;
            const descricao = document.getElementById('financeiroDescricao').value;
            const tipo = document.getElementById('financeiroTipo').value;
            const valor = parseFloat(document.getElementById('financeiroValor').value);

            if (!data || !descricao || !valor) {
                 showStatus("Por favor, preencha todos os campos.", "error");
                return;
            }

            try {
                await addDoc(getFinanceiroCollection(), {
                    data,
                    descricao,
                    tipo,
                    valor,
                    criadoEm: Timestamp.now()
                });
                showStatus("Lançamento salvo com sucesso!", "success");
                e.target.reset();
                document.getElementById('financeiroData').value = new Date().toISOString().split('T')[0]; // Reseta data
            } catch (error) {
                console.error("Erro ao salvar lançamento:", error);
                showStatus("Erro ao salvar o lançamento.", "error");
            }
        });

        // --- GESTÃO DE EXCLUSÃO (MODAL) ---

        const deleteModal = document.getElementById('deleteModal');
        const modalConfirmBtn = document.getElementById('modalConfirmDelete');
        const modalCancelBtn = document.getElementById('modalCancelDelete');
        let deleteId = null;
        let deleteType = null;

        // Abre o modal de confirmação
        window.confirmDelete = (id, type) => {
            deleteId = id;
            deleteType = type;
            deleteModal.classList.remove('hidden');
        }

        // Fecha o modal
        modalCancelBtn.onclick = () => {
            deleteModal.classList.add('hidden');
            deleteId = null;
            deleteType = null;
        }

        // Confirma a exclusão
        modalConfirmBtn.onclick = async () => {
            if (!deleteId || !deleteType) return;

            let docRef;
            let successMessage = "Item excluído com sucesso.";

            try {
                if (deleteType === 'membro') {
                    docRef = doc(db, `artifacts/${appId}/users/${userId}/membros`, deleteId);
                    // TODO: Adicionar lógica para lidar com dízimos órfãos se necessário
                    successMessage = "Membro excluído com sucesso.";
                } else if (deleteType === 'dizimo') {
                    docRef = doc(db, `artifacts/${appId}/users/${userId}/dizimos`, deleteId);
                    // Ao excluir um dízimo, precisamos excluir a entrada financeira correspondente
                    // Primeiro, busca o lançamento financeiro que tem a origemDizimoId
                    const q = query(getFinanceiroCollection(), where("origemDizimoId", "==", deleteId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(async (doc) => {
                        await deleteDoc(doc.ref); // Deleta o lançamento financeiro
                    });
                    
                    successMessage = "Registro de dízimo e lançamento financeiro excluídos.";
                } else if (deleteType === 'financeiro') {
                    docRef = doc(db, `artifacts/${appId}/users/${userId}/financeiro`, deleteId);
                    
                    // Verifica se tem origem de dízimo (não deveria ser excluível por aqui, mas por segurança)
                    const docSnap = await getDoc(docRef);
                    if (docSnap.data().origemDizimoId) {
                        throw new Error("Este lançamento veio de um dízimo. Exclua o registro de dízimo para estornar.");
                    }
                    
                    successMessage = "Lançamento financeiro excluído.";
                } else {
                    throw new Error("Tipo de exclusão desconhecido.");
                }

                if (deleteType !== 'dizimo') { // No 'dizimo', a ref principal é deletada depois
                     await deleteDoc(docRef);
                }
                
                if (deleteType === 'dizimo') {
                     await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/dizimos`, deleteId));
                }

                showStatus(successMessage, "success");
            } catch (error) {
                console.error("Erro ao excluir:", error);
                showStatus(error.message || "Erro ao excluir o item.", "error");
            } finally {
                // Fecha o modal independentemente do resultado
                modalCancelBtn.click();
            }
        }

        // --- GESTÃO DE DETALHES (MODAL) ---

        const detailModal = document.getElementById('memberDetailModal');
        const detailModalContent = document.getElementById('memberDetailContent');
        const modalCloseDetails = document.getElementById('modalCloseDetails');
        const modalCloseDetailsBtn = document.getElementById('modalCloseDetailsBtn');

        // Função para fechar o modal de detalhes
        const closeDetailModal = () => {
            detailModal.classList.add('hidden');
            detailModalContent.innerHTML = '<p class="text-center text-gray-500 py-4">Carregando...</p>'; // Reset
        }

        // Event listeners for closing
        modalCloseDetails.onclick = closeDetailModal;
        modalCloseDetailsBtn.onclick = closeDetailModal;

        // Função para MOSTRAR o modal de detalhes
        window.showMemberDetails = (memberId) => {
            if (!listaMembrosCache) return;
            
            const member = listaMembrosCache.find(m => m.id === memberId);
            if (!member) {
                showStatus("Membro não encontrado.", "error");
                return;
            }

            // Helper function for display
            const detailItem = (label, value) => {
                // Substitui quebras de linha por <br> para o endereço
                const val = value ? String(value).replace(/\n/g, '<br>') : '<span class="text-gray-400">N/A</span>';
                return `<div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 px-1">
                            <dt class="text-sm font-medium text-gray-500">${label}</dt>
                            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">${val}</dd>
                        </div>`;
            };

            detailModalContent.innerHTML = `
                ${detailItem('Nome Completo', member.nome)}
                ${detailItem('Função / Ministério', member.funcao)}
                ${detailItem('Telefone', member.telefone)}
                ${detailItem('Email', 'email')}
                ${detailItem('Data de Nascimento', member.nascimento ? formatDate(member.nascimento) : null)}
                ${detailItem('Data de Batismo', member.batismo ? formatDate(member.batismo) : null)}
                ${detailItem('Endereço', member.endereco)}
            `;
            
            detailModal.classList.remove('hidden');
        }

        // --- INICIALIZAÇÃO DA PÁGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
            lucide.createIcons();
            
            // Define data atual nos campos de data por padrão
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dizimoData').value = today;
            document.getElementById('financeiroData').value = today;
        });

    </script>
</body>
</html>

